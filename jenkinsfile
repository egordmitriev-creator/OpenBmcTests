pipeline {
    agent any
    
    environment {
        QEMU_IMAGE = '/romulus/obmc-phosphor-image-romulus-20250415053117.static.mtd'
    }

    stages {
        stage('Install package') {
            steps {
                script {
                    sh """
                    apt-get update
                    apt-get install -y qemu-system-arm wget
                    """
                }
            }
        }

        stage('Install romulus') {
            steps {
                script {
                    sh "wget https://jenkins.openbmc.org/job/ci-openbmc/lastSuccessfulBuild/distro=ubuntu,label=docker-builder,target=romulus/artifact/openbmc/build/tmp/deploy/images/romulus/*zip*/romulus.zip"
                }
            }
        }

        stage('Unzip pomulus') {
            steps {
                script {
                    sh "unzip -o romulus.zip"
                }
            }
        }
    
        stage('Start qemu with OpenBmc') {
            steps {
                script {
                    sh "qemu-system-arm \
                        -m 256 \
                        -M romulus-bmc \
                        -nographic \
                        -drive file=${QEMU_IMAGE},format=raw,if=mtd \
                        -net nic \
                        -net user,hostfwd=:0.0.0.0:2222-:22,hostfwd=:0.0.0.0:2443-:443,hostfwd=udp:0.0.0.0:2623-:623"
                }
            }
        }
    }
}